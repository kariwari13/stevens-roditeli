import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, Mic, MicOff, Volume2, RotateCcw, CheckCircle, XCircle, Baby, Users, MessageCircle } from 'lucide-react';

const RussianFamilyApp = () => {
  const [currentTask, setCurrentTask] = useState(null);
  const [userAnswer, setUserAnswer] = useState('');
  const [showResult, setShowResult] = useState(null);
  const [score, setScore] = useState({ correct: 0, total: 0 });
  const [isRecording, setIsRecording] = useState(false);
  const [activeTab, setActiveTab] = useState('tasks');
  const [selectedCategory, setSelectedCategory] = useState('all');
  
  const mediaRecorderRef = useRef(null);
  const audioChunksRef = useRef([]);

  // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const vocabulary = {
    baby_care: {
      '–ø–∏—Å–∞—Ç—å-–ø–æ–ø–∏—Å–∞—Ç—å': { 
        definition: 'to urinate', 
        example: '–û–Ω–∞ –ø–æ–ø–∏—Å–∞–ª–∞ –≤ –ø–∞–º–ø–µ—Ä—Å',
        forms: '–ø–∏—Å–∞—Ç—å/–ø–æ–ø–∏—Å–∞—Ç—å - –æ–Ω–∞ –ø–∏—Å–∞–µ—Ç/–ø–æ–ø–∏—Å–∞–µ—Ç'
      },
      '–∫–∞–∫–∞—Ç—å-–ø–æ–∫–∞–∫–∞—Ç—å': { 
        definition: 'to defecate', 
        example: '–†–µ–±—ë–Ω–æ–∫ –ø–æ–∫–∞–∫–∞–ª',
        forms: '–∫–∞–∫–∞—Ç—å/–ø–æ–∫–∞–∫–∞—Ç—å - –æ–Ω –∫–∞–∫–∞–µ—Ç/–ø–æ–∫–∞–∫–∞–µ—Ç'
      },
      '–ø–∞–º–ø–µ—Ä—Å': { 
        definition: 'diaper', 
        example: '–ù—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –ø–∞–º–ø–µ—Ä—Å',
        forms: '–ø–∞–º–ø–µ—Ä—Å - –ø–∞–º–ø–µ—Ä—Å–∞ - –ø–∞–º–ø–µ—Ä—Å—É - –ø–∞–º–ø–µ—Ä—Å - –ø–∞–º–ø–µ—Ä—Å–æ–º - –æ –ø–∞–º–ø–µ—Ä—Å–µ'
      },
      '—Å–æ—Å–∫–∞': { 
        definition: 'pacifier', 
        example: '–î–∞–π –µ–π —Å–æ—Å–∫—É',
        forms: '—Å–æ—Å–∫–∞ - —Å–æ—Å–∫–∏ - —Å–æ—Å–∫–µ - —Å–æ—Å–∫—É - —Å–æ—Å–∫–æ–π - –æ —Å–æ—Å–∫–µ'
      },
      '–∫–æ–ª–∏–∫–∏': { 
        definition: 'colic', 
        example: '–£ –Ω–µ—ë –∫–æ–ª–∏–∫–∏',
        forms: '–∫–æ–ª–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ)'
      },
      '–æ—Ç—Ä—ã–∂–∫–∞': { 
        definition: 'burp', 
        example: '–£ –Ω–µ—ë –æ—Ç—Ä—ã–∂–∫–∞',
        forms: '–æ—Ç—Ä—ã–∂–∫–∞ - –æ—Ç—Ä—ã–∂–∫–∏ - –æ—Ç—Ä—ã–∂–∫–µ'
      },
      '—Ä—ã–≥–∞—Ç—å-—Ä—ã–≥–Ω—É—Ç—å': { 
        definition: 'to burp', 
        example: '–û–Ω–∞ —Å–µ–π—á–∞—Å —Ä—ã–≥–Ω—ë—Ç',
        forms: '—Ä—ã–≥–∞—Ç—å/—Ä—ã–≥–Ω—É—Ç—å - —Ä—ã–≥–∞–µ—Ç/—Ä—ã–≥–Ω–µ—Ç'
      },
      '–ø–µ–ª—ë–Ω–∫–∞': { 
        definition: 'swaddle cloth', 
        example: '–ó–∞–≤–µ—Ä–Ω–∏ –µ—ë –≤ –ø–µ–ª—ë–Ω–∫—É',
        forms: '–ø–µ–ª—ë–Ω–∫–∞ - –ø–µ–ª—ë–Ω–∫–∏ - –ø–µ–ª—ë–Ω–∫–µ'
      },
      '–ª—é–ª—å–∫–∞': { 
        definition: 'cradle', 
        example: '–ü–æ–ª–æ–∂–∏ –µ—ë –≤ –ª—é–ª—å–∫—É',
        forms: '–ª—é–ª—å–∫–∞ - –ª—é–ª—å–∫–∏ - –ª—é–ª—å–∫–µ'
      },
      '–∫–æ—Ä–º–ª–µ–Ω–∏–µ': { 
        definition: 'feeding', 
        example: '–í—Ä–µ–º—è –∫–æ—Ä–º–ª–µ–Ω–∏—è',
        forms: '–∫–æ—Ä–º–ª–µ–Ω–∏–µ - –∫–æ—Ä–º–ª–µ–Ω–∏—è - –∫–æ—Ä–º–ª–µ–Ω–∏—é - –∫–æ—Ä–º–ª–µ–Ω–∏–µ - –∫–æ—Ä–º–ª–µ–Ω–∏–µ–º - –æ –∫–æ—Ä–º–ª–µ–Ω–∏–∏'
      },
      '–∫—É–ø–∞—Ç—å-–≤—ã–∫—É–ø–∞—Ç—å': { 
        definition: 'to bathe', 
        example: '–ù–∞–¥–æ –µ—ë –≤—ã–∫—É–ø–∞—Ç—å',
        forms: '–∫—É–ø–∞—Ç—å/–≤—ã–∫—É–ø–∞—Ç—å - –∫—É–ø–∞—é/–≤—ã–∫—É–ø–∞—é'
      },
      '–≤–∞–Ω–Ω–æ—á–∫–∞': { 
        definition: 'baby bath', 
        example: '–ù–∞–ø–æ–ª–Ω–∏ –≤–∞–Ω–Ω–æ—á–∫—É —Ç—ë–ø–ª–æ–π –≤–æ–¥–æ–π',
        forms: '–≤–∞–Ω–Ω–æ—á–∫–∞ - –≤–∞–Ω–Ω–æ—á–∫–∏ - –≤–∞–Ω–Ω–æ—á–∫–µ'
      },
      '–∫–æ–ª—è—Å–∫–∞': { 
        definition: 'stroller', 
        example: '–í–æ–∑—å–º–∏ –∫–æ–ª—è—Å–∫—É, –ø–æ–π–¥—ë–º –≥—É–ª—è—Ç—å',
        forms: '–∫–æ–ª—è—Å–∫–∞ - –∫–æ–ª—è—Å–∫–∏ - –∫–æ–ª—è—Å–∫–µ'
      },
      '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞': { 
        definition: 'temperature', 
        example: '–£ –Ω–µ—ë —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',
        forms: '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã - —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ'
      },
      '–≥—Ä–∞–¥—É—Å–Ω–∏–∫': { 
        definition: 'thermometer', 
        example: '–ì–¥–µ –≥—Ä–∞–¥—É—Å–Ω–∏–∫?',
        forms: '–≥—Ä–∞–¥—É—Å–Ω–∏–∫ - –≥—Ä–∞–¥—É—Å–Ω–∏–∫–∞ - –≥—Ä–∞–¥—É—Å–Ω–∏–∫—É'
      },
      '–≥—Ä—É–¥—å': { 
        definition: 'breast (feeding)', 
        example: '–û–Ω–∞ —Ö–æ—á–µ—Ç –≥—Ä—É–¥—å',
        forms: '–≥—Ä—É–¥—å - –≥—Ä—É–¥–∏ - –≥—Ä—É–¥–∏ - –≥—Ä—É–¥—å - –≥—Ä—É–¥—å—é - –æ –≥—Ä—É–¥–∏'
      },
      '–º–æ–ª–æ–∫–æ': { 
        definition: 'milk', 
        example: '–ü—Ä–∏–≥–æ—Ç–æ–≤—å –º–æ–ª–æ–∫–æ',
        forms: '–º–æ–ª–æ–∫–æ - –º–æ–ª–æ–∫–∞ - –º–æ–ª–æ–∫—É'
      },
      '–±—É—Ç—ã–ª–æ—á–∫–∞': { 
        definition: 'bottle', 
        example: '–î–∞–π –µ–π –±—É—Ç—ã–ª–æ—á–∫—É',
        forms: '–±—É—Ç—ã–ª–æ—á–∫–∞ - –±—É—Ç—ã–ª–æ—á–∫–∏ - –±—É—Ç—ã–ª–æ—á–∫–µ'
      }
    },
    family: {
      '–≤–Ω—É—á–∫–∞': { 
        definition: 'granddaughter', 
        example: '–ù–∞—à–∞ –ª—é–±–∏–º–∞—è –≤–Ω—É—á–∫–∞',
        forms: '–≤–Ω—É—á–∫–∞ - –≤–Ω—É—á–∫–∏ - –≤–Ω—É—á–∫–µ - –≤–Ω—É—á–∫—É - –≤–Ω—É—á–∫–æ–π - –æ –≤–Ω—É—á–∫–µ'
      },
      '–ì—É–ª—å–Ω–∞—Ä–∞': { 
        definition: 'mother-in-law\'s name', 
        example: '–ì—É–ª—å–Ω–∞—Ä–∞ –∏–≥—Ä–∞–µ—Ç —Å –≤–Ω—É—á–∫–æ–π',
        forms: '–ì—É–ª—å–Ω–∞—Ä–∞ - –ì—É–ª—å–Ω–∞—Ä—ã - –ì—É–ª—å–Ω–∞—Ä–µ - –ì—É–ª—å–Ω–∞—Ä—É - –ì—É–ª—å–Ω–∞—Ä–æ–π - –æ –ì—É–ª—å–Ω–∞—Ä–µ'
      },
      '–≠—Ä–∏–∫': { 
        definition: 'father-in-law\'s name', 
        example: '–≠—Ä–∏–∫ –ø–æ–º–æ–≥–∞–µ—Ç —Å —Ä–µ–±—ë–Ω–∫–æ–º',
        forms: '–≠—Ä–∏–∫ - –≠—Ä–∏–∫–∞ - –≠—Ä–∏–∫—É - –≠—Ä–∏–∫–∞ - –≠—Ä–∏–∫–æ–º - –æ–± –≠—Ä–∏–∫–µ'
      },
      '–±–∞–±—É—à–∫–∞': { 
        definition: 'grandmother', 
        example: '–ë–∞–±—É—à–∫–∞ –∫–∞—á–∞–µ—Ç –≤–Ω—É—á–∫—É',
        forms: '–±–∞–±—É—à–∫–∞ - –±–∞–±—É—à–∫–∏ - –±–∞–±—É—à–∫–µ - –±–∞–±—É—à–∫—É - –±–∞–±—É—à–∫–æ–π - –æ –±–∞–±—É—à–∫–µ'
      },
      '–¥–µ–¥—É—à–∫–∞': { 
        definition: 'grandfather', 
        example: '–î–µ–¥—É—à–∫–∞ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–∞–∑–∫—É',
        forms: '–¥–µ–¥—É—à–∫–∞ - –¥–µ–¥—É—à–∫–∏ - –¥–µ–¥—É—à–∫–µ - –¥–µ–¥—É—à–∫—É - –¥–µ–¥—É—à–∫–æ–π - –æ –¥–µ–¥—É—à–∫–µ'
      }
    },
    actions: {
      '–¥–µ—Ä–∂–∞—Ç—å-–ø–æ–¥–µ—Ä–∂–∞—Ç—å': { 
        definition: 'to hold', 
        example: '–Ø –¥–µ—Ä–∂—É —Ä–µ–±—ë–Ω–∫–∞',
        forms: '–¥–µ—Ä–∂–∞—Ç—å/–ø–æ–¥–µ—Ä–∂–∞—Ç—å - –¥–µ—Ä–∂—É/–ø–æ–¥–µ—Ä–∂—É - –¥–µ—Ä–∂–∏—à—å/–ø–æ–¥–µ—Ä–∂–∏—à—å'
      },
      '–∫–∞—á–∞—Ç—å-–ø–æ–∫–∞—á–∞—Ç—å': { 
        definition: 'to rock', 
        example: '–ü–æ–∫–∞—á–∞–π –µ—ë –Ω–µ–º–Ω–æ–≥–æ',
        forms: '–∫–∞—á–∞—Ç—å/–ø–æ–∫–∞—á–∞—Ç—å - –∫–∞—á–∞—é/–ø–æ–∫–∞—á–∞—é'
      },
      '—É–∫–ª–∞–¥—ã–≤–∞—Ç—å-—É–ª–æ–∂–∏—Ç—å': { 
        definition: 'to put to bed', 
        example: '–Ø –µ—ë —É–ª–æ–∂–∏–ª —Å–ø–∞—Ç—å',
        forms: '—É–∫–ª–∞–¥—ã–≤–∞—Ç—å/—É–ª–æ–∂–∏—Ç—å - —É–∫–ª–∞–¥—ã–≤–∞—é/—É–ª–æ–∂—É'
      },
      '–Ω—è–Ω—á–∏—Ç—å-–ø–æ–Ω—è–Ω—á–∏—Ç—å': { 
        definition: 'to babysit, care for', 
        example: '–ë–∞–±—É—à–∫–∞ –Ω—è–Ω—á–∏—Ç –≤–Ω—É—á–∫—É',
        forms: '–Ω—è–Ω—á–∏—Ç—å/–ø–æ–Ω—è–Ω—á–∏—Ç—å - –Ω—è–Ω—á—É/–ø–æ–Ω—è–Ω—á—É'
      },
      '–∂–∞–ª–µ—Ç—å-–ø–æ–∂–∞–ª–µ—Ç—å': { 
        definition: 'to feel sorry for, comfort', 
        example: '–ù–µ –∂–∞–ª–µ–π –µ—ë —Ç–∞–∫',
        forms: '–∂–∞–ª–µ—Ç—å/–ø–æ–∂–∞–ª–µ—Ç—å - –∂–∞–ª–µ—é/–ø–æ–∂–∞–ª–µ—é'
      },
      '–≥—É–ª—è—Ç—å': { 
        definition: 'to go for a walk', 
        example: '–ü–æ–π–¥—ë–º —Å –Ω–µ–π –≥—É–ª—è—Ç—å',
        forms: '–≥—É–ª—è—Ç—å - –≥—É–ª—è—é - –≥—É–ª—è–µ—à—å'
      },
      '–∫–æ—Ä–º–∏—Ç—å-–ø–æ–∫–æ—Ä–º–∏—Ç—å': { 
        definition: 'to feed', 
        example: '–ü–æ–∫–æ—Ä–º–∏ –µ—ë',
        forms: '–∫–æ—Ä–º–∏—Ç—å/–ø–æ–∫–æ—Ä–º–∏—Ç—å - –∫–æ—Ä–º–ª—é/–ø–æ–∫–æ—Ä–º–ª—é'
      },
      '–ø–µ—Ä–µ–æ–¥–µ–≤–∞—Ç—å-–ø–µ—Ä–µ–æ–¥–µ—Ç—å': { 
        definition: 'to change clothes', 
        example: '–ü–µ—Ä–µ–æ–¥–µ–Ω—å –µ—ë',
        forms: '–ø–µ—Ä–µ–æ–¥–µ–≤–∞—Ç—å/–ø–µ—Ä–µ–æ–¥–µ—Ç—å - –ø–µ—Ä–µ–æ–¥–µ–≤–∞—é/–ø–µ—Ä–µ–æ–¥–µ–Ω—É'
      },
      '–±—É–¥–∏—Ç—å-—Ä–∞–∑–±—É–¥–∏—Ç—å': { 
        definition: 'to wake up', 
        example: '–ù–µ –±—É–¥–∏ –µ—ë',
        forms: '–±—É–¥–∏—Ç—å/—Ä–∞–∑–±—É–¥–∏—Ç—å - –±—É–∂—É/—Ä–∞–∑–±—É–∂—É'
      }
    }
  };

  // –¢–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π
  const taskTypes = [
    'translation_ru_en',
    'translation_en_ru', 
    'multiple_choice',
    'fill_blanks',
    'listening',
    'speaking',
    'grammar_forms',
    'situational'
  ];

  // –ü—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞–Ω–∏–π
  const sampleTasks = [
    {
      type: 'translation_ru_en',
      category: 'baby_care',
      question: '–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π: "–û–Ω–∞ –ø–æ–ø–∏—Å–∞–ª–∞"',
      answer: 'she urinated',
      alternatives: ['she peed', 'she urinated', 'she wet herself'],
      word: '–ø–∏—Å–∞—Ç—å-–ø–æ–ø–∏—Å–∞—Ç—å'
    },
    {
      type: 'translation_en_ru',
      category: 'baby_care',
      question: 'Translate to Russian: "Change the diaper"',
      answer: '–ø–æ–º–µ–Ω—è–π –ø–∞–º–ø–µ—Ä—Å',
      alternatives: ['—Å–º–µ–Ω–∏ –ø–∞–º–ø–µ—Ä—Å', '–ø–æ–º–µ–Ω—è–π –ø–∞–º–ø–µ—Ä—Å', '–∑–∞–º–µ–Ω–∏ –ø–∞–º–ø–µ—Ä—Å'],
      word: '–ø–∞–º–ø–µ—Ä—Å'
    },
    {
      type: 'multiple_choice',
      category: 'baby_care',
      question: '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: "–£ –Ω–µ—ë ___"',
      options: ['–∫–æ–ª–∏–∫–∞', '–∫–æ–ª–∏–∫–∏', '–∫–æ–ª–∏–∫–æ–≤', '–∫–æ–ª–∏–∫–µ'],
      correct: 1,
      word: '–∫–æ–ª–∏–∫–∏'
    },
    {
      type: 'multiple_choice',
      category: 'actions',
      question: '–ß—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ: "–Ø ___ —Ä–µ–±—ë–Ω–∫–∞ –Ω–∞ —Ä—É–∫–∞—Ö"',
      options: ['–¥–µ—Ä–∂—É', '–¥–µ—Ä–∂–∞—é', '–¥–µ—Ä–∂—é', '–¥–µ—Ä–∂–µ–≤—É'],
      correct: 0,
      word: '–¥–µ—Ä–∂–∞—Ç—å-–ø–æ–¥–µ—Ä–∂–∞—Ç—å'
    },
    {
      type: 'fill_blanks',
      category: 'baby_care',
      question: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫: "–î–∞–π –µ–π ___"',
      answer: '—Å–æ—Å–∫—É',
      hint: '(–ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —Å–æ—Å–∞–Ω–∏—è)',
      word: '—Å–æ—Å–∫–∞'
    },
    {
      type: 'grammar_forms',
      category: 'actions',
      question: '–ü–æ—Å—Ç–∞–≤—å—Ç–µ –≥–ª–∞–≥–æ–ª –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É: "–û–Ω–∞ —Å–µ–π—á–∞—Å ___ (—Ä—ã–≥–∞—Ç—å-—Ä—ã–≥–Ω—É—Ç—å)"',
      answer: '—Ä—ã–≥–Ω–µ—Ç',
      alternatives: ['—Ä—ã–≥–Ω—ë—Ç', '—Ä—ã–≥–Ω–µ—Ç'],
      word: '—Ä—ã–≥–∞—Ç—å-—Ä—ã–≥–Ω—É—Ç—å'
    },
    {
      type: 'situational',
      category: 'family',
      question: '–°–∏—Ç—É–∞—Ü–∏—è: –ì—É–ª—å–Ω–∞—Ä–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞ —É –≤–Ω—É—á–∫–∏. –û—Ç–≤–µ—Ç—å.',
      context: '–†–µ–±—ë–Ω–æ–∫ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–µ–ª –∏ —Å–ø–∏—Ç.',
      expectedElements: ['—Ö–æ—Ä–æ—à–æ', '–ø–æ–µ–ª–∞', '—Å–ø–∏—Ç'],
      word: '–≤–Ω—É—á–∫–∞'
    },
    {
      type: 'listening',
      category: 'baby_care',
      question: '–ü—Ä–æ—Å–ª—É—à–∞–π—Ç–µ —Ñ—Ä–∞–∑—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ',
      audio: '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –æ–Ω–∞ —Å–µ–π—á–∞—Å –Ω–∞ —Ç–µ–±—è —Ä—ã–≥–Ω—ë—Ç',
      word: '—Ä—ã–≥–∞—Ç—å-—Ä—ã–≥–Ω—É—Ç—å'
    }
  ];

  const generateRandomTask = () => {
    const filteredTasks = selectedCategory === 'all' 
      ? sampleTasks 
      : sampleTasks.filter(task => task.category === selectedCategory);
    
    const randomTask = filteredTasks[Math.floor(Math.random() * filteredTasks.length)];
    setCurrentTask({...randomTask, id: Date.now()});
    setUserAnswer('');
    setShowResult(null);
  };

  const checkAnswer = () => {
    if (!currentTask) return;
    
    let isCorrect = false;
    
    switch(currentTask.type) {
      case 'multiple_choice':
        isCorrect = parseInt(userAnswer) === currentTask.correct;
        break;
      case 'translation_ru_en':
      case 'translation_en_ru':
      case 'fill_blanks':
      case 'grammar_forms':
        const normalizedAnswer = userAnswer.toLowerCase().trim();
        if (currentTask.alternatives) {
          isCorrect = currentTask.alternatives.some(alt => 
            alt.toLowerCase() === normalizedAnswer
          );
        } else {
          isCorrect = normalizedAnswer === currentTask.answer.toLowerCase();
        }
        break;
      case 'situational':
        isCorrect = currentTask.expectedElements.some(element =>
          userAnswer.toLowerCase().includes(element.toLowerCase())
        );
        break;
      default:
        isCorrect = true; // –î–ª—è –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –≥–æ–≤–æ—Ä–µ–Ω–∏–µ –∏ —Å–ª—É—à–∞–Ω–∏–µ
    }
    
    setScore(prev => ({
      correct: prev.correct + (isCorrect ? 1 : 0),
      total: prev.total + 1
    }));
    
    setShowResult(isCorrect);
    
    setTimeout(() => {
      generateRandomTask();
    }, 2000);
  };

  const speakText = (text) => {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ru-RU';
      utterance.rate = 0.8;
      window.speechSynthesis.speak(utterance);
    }
  };

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      audioChunksRef.current = [];

      mediaRecorder.ondataavailable = (event) => {
        audioChunksRef.current.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/wav' });
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ
        setUserAnswer('–ì–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç –∑–∞–ø–∏—Å–∞–Ω ‚úì');
      };

      mediaRecorder.start();
      setIsRecording(true);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
    }
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && isRecording) {
      mediaRecorderRef.current.stop();
      mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());
      setIsRecording(false);
    }
  };

  useEffect(() => {
    generateRandomTask();
  }, [selectedCategory]);

  const renderTask = () => {
    if (!currentTask) return null;

    switch(currentTask.type) {
      case 'multiple_choice':
        return (
          <div className="space-y-4">
            <p className="text-lg font-medium">{currentTask.question}</p>
            <div className="grid grid-cols-2 gap-2">
              {currentTask.options.map((option, index) => (
                <button
                  key={index}
                  onClick={() => setUserAnswer(index.toString())}
                  className={`p-3 border rounded-lg transition-colors ${
                    userAnswer === index.toString()
                      ? 'bg-blue-500 text-white'
                      : 'bg-white hover:bg-gray-50'
                  }`}
                >
                  {option}
                </button>
              ))}
            </div>
          </div>
        );
      
      case 'listening':
        return (
          <div className="space-y-4">
            <p className="text-lg font-medium">{currentTask.question}</p>
            <button
              onClick={() => speakText(currentTask.audio)}
              className="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600"
            >
              <Volume2 size={20} />
              –ü—Ä–æ—Å–ª—É—à–∞—Ç—å
            </button>
            <div className="flex items-center gap-2">
              <button
                onClick={isRecording ? stopRecording : startRecording}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg ${
                  isRecording 
                    ? 'bg-red-500 hover:bg-red-600' 
                    : 'bg-blue-500 hover:bg-blue-600'
                } text-white`}
              >
                {isRecording ? <MicOff size={20} /> : <Mic size={20} />}
                {isRecording ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç'}
              </button>
            </div>
            <p className="text-sm text-gray-600">–ü—Ä–æ—Å–ª—É—à–∞–π—Ç–µ —Ñ—Ä–∞–∑—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –µ—ë –≤—Å–ª—É—Ö</p>
          </div>
        );
      
      case 'situational':
        return (
          <div className="space-y-4">
            <div className="bg-yellow-50 p-4 rounded-lg">
              <h3 className="font-semibold text-yellow-800">–°–∏—Ç—É–∞—Ü–∏—è:</h3>
              <p className="text-yellow-700">{currentTask.question}</p>
              {currentTask.context && (
                <p className="text-sm text-yellow-600 mt-2">
                  –ö–æ–Ω—Ç–µ–∫—Å—Ç: {currentTask.context}
                </p>
              )}
            </div>
            <textarea
              value={userAnswer}
              onChange={(e) => setUserAnswer(e.target.value)}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
              className="w-full p-3 border border-gray-300 rounded-lg"
              rows="3"
            />
            <div className="flex gap-2">
              <button
                onClick={isRecording ? stopRecording : startRecording}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg ${
                  isRecording 
                    ? 'bg-red-500 hover:bg-red-600' 
                    : 'bg-blue-500 hover:bg-blue-600'
                } text-white`}
              >
                {isRecording ? <MicOff size={20} /> : <Mic size={20} />}
                –ì–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç
              </button>
            </div>
          </div>
        );
      
      default:
        return (
          <div className="space-y-4">
            <p className="text-lg font-medium">{currentTask.question}</p>
            {currentTask.hint && (
              <p className="text-sm text-gray-600">{currentTask.hint}</p>
            )}
            <input
              type="text"
              value={userAnswer}
              onChange={(e) => setUserAnswer(e.target.value)}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
              className="w-full p-3 border border-gray-300 rounded-lg"
              onKeyPress={(e) => e.key === 'Enter' && checkAnswer()}
            />
            <div className="flex gap-2">
              <button
                onClick={isRecording ? stopRecording : startRecording}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg ${
                  isRecording 
                    ? 'bg-red-500 hover:bg-red-600' 
                    : 'bg-blue-500 hover:bg-blue-600'
                } text-white`}
              >
                {isRecording ? <MicOff size={20} /> : <Mic size={20} />}
                –ì–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç
              </button>
            </div>
          </div>
        );
    }
  };

  const renderVocabulary = () => (
    <div className="space-y-6">
      {Object.entries(vocabulary).map(([category, words]) => (
        <div key={category} className="bg-white rounded-lg p-6 shadow-sm border">
          <h3 className="text-xl font-semibold mb-4 text-blue-600">
            {category === 'baby_care' ? 'üë∂ –£—Ö–æ–¥ –∑–∞ —Ä–µ–±—ë–Ω–∫–æ–º' :
             category === 'family' ? 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è' : 'ü§≤ –î–µ–π—Å—Ç–≤–∏—è'}
          </h3>
          <div className="grid gap-4">
            {Object.entries(words).map(([word, info]) => (
              <div key={word} className="border-l-4 border-blue-200 pl-4">
                <div className="flex items-center justify-between">
                  <h4 className="font-semibold text-lg">{word}</h4>
                  <button
                    onClick={() => speakText(word)}
                    className="text-blue-500 hover:text-blue-700"
                  >
                    <Volume2 size={20} />
                  </button>
                </div>
                <p className="text-gray-600">{info.definition}</p>
                <p className="text-green-700 italic">"{info.example}"</p>
                <p className="text-sm text-gray-500">{info.forms}</p>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );

  return (
    <div className="max-w-4xl mx-auto bg-gray-50 min-h-screen">
      {/* Header */}
      <div className="bg-blue-600 text-white p-6">
        <h1 className="text-2xl font-bold flex items-center gap-2">
          <Baby size={28} />
          –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–±—â–µ–Ω–∏—é —Å —Ä—É—Å—Å–∫–∏–º–∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º–∏
        </h1>
        <p className="mt-2 opacity-90">
          –ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –ø—Ä–∏–µ–∑–¥—É —Ä–æ–¥–∏—Ç–µ–ª–µ–π –∂–µ–Ω—ã –∏–∑ –†–æ—Å—Å–∏–∏
        </p>
        <div className="mt-4 flex gap-4 text-sm">
          <span>–ü—Ä–∞–≤–∏–ª—å–Ω–æ: {score.correct}</span>
          <span>–í—Å–µ–≥–æ: {score.total}</span>
          <span>–¢–æ—á–Ω–æ—Å—Ç—å: {score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0}%</span>
        </div>
      </div>

      {/* Navigation */}
      <div className="flex border-b bg-white">
        <button
          onClick={() => setActiveTab('tasks')}
          className={`flex-1 p-4 text-center font-medium ${
            activeTab === 'tasks' 
              ? 'border-b-2 border-blue-500 text-blue-600' 
              : 'text-gray-600 hover:text-gray-800'
          }`}
        >
          <MessageCircle className="mx-auto mb-1" size={20} />
          –ó–∞–¥–∞–Ω–∏—è
        </button>
        <button
          onClick={() => setActiveTab('vocabulary')}
          className={`flex-1 p-4 text-center font-medium ${
            activeTab === 'vocabulary' 
              ? 'border-b-2 border-blue-500 text-blue-600' 
              : 'text-gray-600 hover:text-gray-800'
          }`}
        >
          <Users className="mx-auto mb-1" size={20} />
          –°–ª–æ–≤–∞—Ä—å
        </button>
      </div>

      {/* Content */}
      <div className="p-6">
        {activeTab === 'tasks' && (
          <div className="space-y-6">
            {/* Category Filter */}
            <div className="flex gap-2 flex-wrap">
              <button
                onClick={() => setSelectedCategory('all')}
                className={`px-4 py-2 rounded-lg ${
                  selectedCategory === 'all' 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-white border hover:bg-gray-50'
                }`}
              >
                –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
              </button>
              <button
                onClick={() => setSelectedCategory('baby_care')}
                className={`px-4 py-2 rounded-lg ${
                  selectedCategory === 'baby_care' 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-white border hover:bg-gray-50'
                }`}
              >
                üë∂ –£—Ö–æ–¥ –∑–∞ —Ä–µ–±—ë–Ω–∫–æ–º
              </button>
              <button
                onClick={() => setSelectedCategory('family')}
                className={`px-4 py-2 rounded-lg ${
                  selectedCategory === 'family' 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-white border hover:bg-gray-50'
                }`}
              >
                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è
              </button>
              <button
                onClick={() => setSelectedCategory('actions')}
                className={`px-4 py-2 rounded-lg ${
                  selectedCategory === 'actions' 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-white border hover:bg-gray-50'
                }`}
              >
                ü§≤ –î–µ–π—Å—Ç–≤–∏—è
              </button>
            </div>

            {/* Task Card */}
            <div className="bg-white rounded-lg p-6 shadow-sm border">
              {showResult !== null && (
                <div className={`mb-4 p-4 rounded-lg flex items-center gap-2 ${
                  showResult 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-red-100 text-red-800'
                }`}>
                  {showResult ? <CheckCircle size={20} /> : <XCircle size={20} />}
                  {showResult ? '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!' : `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${currentTask?.answer || '—Å–º. –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã—à–µ'}`}
                </div>
              )}
              
              {renderTask()}
              
              {currentTask && showResult === null && (
                <div className="mt-6 flex gap-3">
                  <button
                    onClick={checkAnswer}
                    disabled={!userAnswer.trim()}
                    className="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                  </button>
                  <button
                    onClick={generateRandomTask}
                    className="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2"
                  >
                    <RotateCcw size={16} />
                    –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                  </button>
                </div>
              )}
            </div>

            {/* Word Info */}
            {currentTask?.word && vocabulary[currentTask.category]?.[currentTask.word] && (
              <div className="bg-blue-50 rounded-lg p-4">
                <h3 className="font-semibold text-blue-800 mb-2">–ò–∑—É—á–∞–µ–º–æ–µ —Å–ª–æ–≤–æ:</h3>
                <div className="text-blue-700">
                  <p className="font-medium">{currentTask.word}</p>
                  <p className="text-sm">{vocabulary[currentTask.category][currentTask.word].forms}</p>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'vocabulary' && renderVocabulary()}
      </div>
    </div>
  );
};

export default RussianFamilyApp;
